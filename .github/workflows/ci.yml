name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-and-test:
    name: Build & Test (gcc ${{ matrix.gcc }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gcc: [11, 12, 13]   # 2 or 3 versions, choose any 2â€“3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-${{ matrix.gcc }} g++-${{ matrix.gcc }} cmake make libcjson-dev


      - name: Configure (CMake)
        env:
          CC: gcc-${{ matrix.gcc }}
          CXX: g++-${{ matrix.gcc }}
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: |
          cmake --build build --config Debug

      - name: Run unit tests (ctest)
        run: |
          cd build
          ctest --output-on-failure

  analysis:
    name: Static analysis & quality gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make cppcheck clang-format
          # gitleaks: download binary release (simple)
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          sudo apt-get install -y cmake make cppcheck clang-format libcjson-dev


      - name: Configure (CMake)
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

      - name: Run cppcheck (via your CMake target)
        run: |
          cmake --build build --target static-analysis

      - name: clang-format check (fails if formatting differs)
        run: |
          # Adjust extensions/paths if needed
          FILES=$(find src tests -type f \( -name "*.c" -o -name "*.h" \))
          clang-format --dry-run --Werror $FILES

      - name: Secret scan (gitleaks)
        run: |
          gitleaks detect --source . --no-git --redact --exit-code 1
